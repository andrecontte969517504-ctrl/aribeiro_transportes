<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro Aribeiro Transportes</title>
<style>
    body {
        background: #f5f5f5; /* fundo original Aribeiro */
        color: #333;
        font-family: Arial, sans-serif;
        padding: 20px;
        text-align: center;
    }
    .caixa {
        border: 1px solid #333;
        padding: 20px;
        border-radius: 10px;
        width: 340px;
        margin: auto;
        background: #fff;
        box-shadow: 0 0 15px #999;
    }
    input, select, button {
        width: 95%;
        padding: 10px;
        margin: 8px 0;
        border-radius: 6px;
        border: 1px solid #333;
        background: #fff;
        color: #333;
    }
    button {
        background: #eee;
        cursor: pointer;
    }
    button:hover {
        background: #333;
        color: #fff;
    }
    .voltar {
        display: block;
        margin-top: 20px;
        color: #333;
        text-decoration: none;
    }
</style>
</head>
<body>

<h2>Cadastro Aribeiro Transportes</h2>

<div class="caixa">
    <input id="nomeCad" placeholder="Nome completo">
    <input id="cpfCad" placeholder="CPF">
    <input id="telefoneCad" placeholder="Telefone">
    <select id="tipoCad">
        <option value="">Selecione tipo</option>
        <option value="gerente">Gerente</option>
        <option value="motorista">Motorista</option>
        <option value="ajudante">Ajudante</option>
        <option value="cliente">Cliente</option>
    </select>
    <input id="enderecoCad" placeholder="Endereço">
    <input id="senhaCad" type="password" placeholder="Senha">
    <input id="chavePixCad" placeholder="Chave Pix (opcional)">

    <button id="btnEnviarCadastro">Cadastrar</button>
    <button id="btnLimparCadastro">Limpar</button>
    <button id="btnImprimirCadastro">Imprimir PDF</button>

    <div id="mensagemCadastro" style="margin-top: 10px;"></div>
</div>

<a href="/login" class="voltar">← Voltar ao Login</a>

<script>
const SUPABASE_URL = 'https://wicbydfuhxnsudoorsjf.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpY2J5ZGZ1aHhuc3Vkb29yc2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMzE4NDYsImV4cCI6MjA4MzYwNzg0Nn0.sMmQq9t1mbAxYzkjh6To-Eo6AIWpiUvTq_t_vXMB2I';

function setCookie(name,value,days){
    let expires="";
    if(days){
        let d=new Date();
        d.setTime(d.getTime()+(days*24*60*60*1000));
        expires="; expires="+d.toUTCString();
    }
    document.cookie=name+"="+(value||"")+expires+"; path=/";
}

function mostrarMensagem(msg, cor='gold'){
    const div = document.getElementById('mensagemCadastro');
    div.textContent = msg;
    div.style.color = cor;
}

document.addEventListener('DOMContentLoaded', function(){

    document.getElementById('btnEnviarCadastro').addEventListener('click', async function(){
        const data = {
            nome: document.getElementById('nomeCad').value.trim(),
            cpf: document.getElementById('cpfCad').value.trim() || null,
            telefone: document.getElementById('telefoneCad').value.trim() || null,
            tipo: document.getElementById('tipoCad').value || null,
            endereco: document.getElementById('enderecoCad').value.trim() || null,
            senha: document.getElementById('senhaCad').value,
            chave_pix: document.getElementById('chavePixCad').value.trim() || null
        };

        if(!data.nome || !data.senha || !data.tipo){
            mostrarMensagem('Preencha todos os campos obrigatórios!');
            return;
        }

        // Cookie + localStorage
        setCookie('usuario', data.nome, 7);
        localStorage.setItem('usuario', JSON.stringify(data));

        try {
            // Verifica duplicidade por CPF
            const check = await fetch(`${SUPABASE_URL}/rest/v1/cadastro?cpf=eq.${data.cpf}`, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type':'application/json'
                }
            });
            const existing = await check.json();
            if(existing.length>0){
                mostrarMensagem('CPF já cadastrado!', 'red');
                return;
            }

            // Insere na tabela
            const insert = await fetch(`${SUPABASE_URL}/rest/v1/cadastro`, {
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Prefer':'return=minimal'
                },
                body: JSON.stringify([data])
            });

            if(!insert.ok) throw new Error('Erro ao cadastrar');
            mostrarMensagem('Cadastro realizado com sucesso! ✅','green');
            setTimeout(()=>window.location.href='index.html',2000);

        } catch(err){
            mostrarMensagem('Erro: '+err.message,'red');
        }
    });

    document.getElementById('btnLimparCadastro').addEventListener('click', function(){
        ['nomeCad','cpfCad','telefoneCad','tipoCad','enderecoCad','senhaCad','chavePixCad'].forEach(id=>{
            if(document.getElementById(id)) document.getElementById(id).value='';
        });
        localStorage.clear();
        setCookie('usuario','',-1);
        mostrarMensagem('Campos limpos!','gold');
    });

    document.getElementById('btnImprimirCadastro').addEventListener('click', function(){
        const conteudo = document.querySelector('.caixa').innerHTML;
        const win = window.open("","_blank");
        win.document.write("<html><head><title>Cadastro PDF</title></head><body>"+conteudo+"</body></html>");
        win.print();
    });

});
</script>

</body>
</html>
